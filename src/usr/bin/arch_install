#!/usr/bin/env bash
# Copyright (C) 2022 Vladimir Titov

init() {

setfont cyr-sun16.psfu.gz

dialog --backtitle "Arch Linux Installer"  --title "Welcome to Arch Linux Installer" \
    --ok-label "Begin Installation" --msgbox "Navigating the installer is \
easy.\nYou may select options using the ARROW keys and SPACE or \
ENTER.\nAlternate keys may also be used: '+', '-', and TAB." 7 70
}

# Proceed with installation only if there is an internet connection
check_connection() {
  dialog --infobox "Checking internet connection..." 3 50
  # Check if a web page is available
  if ! nc -zw1 archlinux.org 443; then
    dialog --title "Connect to the Internet" \
      --msgbox "The installer was unable to detect a working internet \
connection. The installation media supports wired network devices on \
boot. Make sure the cable is plugged in. Wireless users should use the \
'iwctl' command to connect to a wireless connection.\n\nOnce you have \
a working internet connection, retry running the installer." 10 80
#    reset ; exit 1
  iwd
  fi
}

# Menu which allows the user to navigate the installer
main_menu() {
  while true; do
    choice=$(dialog --title "Main Menu" --nocancel \
      --menu "Select an option below using the UP/DOWN keys and SPACE or \
ENTER.\nAlternate keys may also be used: '+', '-', and TAB." 19 70 11 \
"KEYMAP" "Set the keyboard layout" \
"LOCALE" "Set the system locale" \
"TIMEZONE" "Set the system time zone" \
"HOSTNAME" "Set the system's hostname" \
"ROOT PASSWORD" "Set the root password" \
"CREATE USER" "Create your user account" \
"PARTITION" "Partition the installation drive" \
"UPDATE MIRRORS" "Update the pacman mirror list" \
"INSTALL" "Install Arch Linux" \
"REBOOT" "Reboot system" \
"EXIT" "Exit Arch Linux Installer" 3>&1 1>&2 2>&3)

    case "$choice" in
      "KEYMAP") set_keymap ;;
      "LOCALE") set_locale ;;
      "TIMEZONE") set_timezone ;;
      "HOSTNAME") set_hostname ;;
      "ROOT PASSWORD") set_root_passwd ;;
      "CREATE USER") create_user ;;
      "PARTITION") if $mounted; then
                     dialog --title "Partition the Disks" \
                       --yesno "A disk is mounted on the system and ready for \
installation.\n\nAre you sure you want to return to partitioning?" 7 70
                     if [ $? -eq 0 ]; then
                       mounted=false
                       prepare_disk
                     fi
                   else
                    prepare_disk
                   fi
                   ;;
      "UPDATE MIRRORS") update_mirrorlist ;;
      "INSTALL") if $mounted; then
                   configure_install
                   install_base
                   configure_system
                   reboot_system
                 else
                   dialog --title "ERROR: No Filesytem Mounted" \
                     --yesno "The installer was unable to detect a \
mounted filesystem.\n\nReturn to partitioning?" 7 60
                   if [ $? -eq 0 ]; then
                     prepare_disk
                   fi
                 fi
                 ;;
      "REBOOT") reboot_system ;;
      "EXIT") reset ; exit ;;
    esac
  done
}


main() {
  init
  check_connection
  set_keymap
  set_locale
  set_timezone
  set_hostname
  set_root_passwd
  create_user
  prepare_disk
  update_mirrorlist
  configure_install
  install_base
  configure_system
  reboot_system
}

main
